/*!
 * AetherCipher v1.0.1
 * 
 * [AetherCipher - Public]{@link https://cdn.jsdelivr.net/gh/msentimental/AetherCipher/build/aethercipher.min.js}
 *
 * @version 1.0.1
 * @author msentimental [lijinhan2025@gmail.com]
 * @copyright Strike Bot Inc. 2026
 * @license UNLICENSED - All Rights Reserved
 */

class AetherCipher{constructor(e){this.blockSize=16,this.halfSize=8,this.rounds=16,this.masterKey=this._hashTo256(e),this._initKeySchedule()}_hashTo256(e){const t=String(e);let n=new Uint32Array(8);n[0]=0x6a09e667,n[1]=0xbb67ae85,n[2]=0x3c6ef372,n[3]=0xa54ff53a,n[4]=0x510e527f,n[5]=0x9b05688c,n[6]=0x1f83d9ab,n[7]=0x5be0cd19;for(let e=0;e<t.length;e++){let r=t.charCodeAt(e);for(let e=0;e<8;e++)n[e]^=(r<<3*e)|r>>>5-e,n[e]=4294967295&n[e]*2654435769,n[e]^=n[3&e+3]^n[7&e+7]}let r=new Uint8Array(32);for(let e=0;e<8;e++)r[4*e]=n[e]>>24&255,r[4*e+1]=n[e]>>16&255,r[4*e+2]=n[e]>>8&255,r[4*e+3]=255&n[e];return r}_entropyBoost(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++){let r=e[n],i=e[(n+1)%e.length],a=e[(n+2)%e.length];t[n]=(r^i^a^n)&255,t[n]^=((r<<1)|(i>>7))&255,t[n]=t[n]*2654435769>>>24}return t}_initKeySchedule(){let e=new Uint8Array(16*this.halfSize),t=0;for(let n=0;n<32;n++)t^=this.masterKey[n]<<n%4*8;const n=this._chaoticRng(t);for(let t=0;t<e.length;t++)e[t]=255*Math.floor(n());for(let t=0;t<32;t++)e[t]^=this.masterKey[t],e[e.length-1-t]^=this.masterKey[t];this.roundKeys=[];for(let t=0;t<this.rounds;t++)this.roundKeys.push(e.slice(t*this.halfSize,(t+1)*this.halfSize));this.sboxes=[];for(let e=0;e<8;e++){let t=new Uint8Array(256);for(let n=0;n<256;n++){let r=n;r^=this.masterKey[(e+n)%32],r=(r<<5|r>>3)&255,r=r+Math.floor(256*(.5*Math.sin(n*e)+.5))&255,t[n]=r}this._makePermutation(t),this.sboxes.push(t)}this.invSboxes=[];for(let e=0;e<8;e++){let t=new Uint8Array(256);for(let n=0;n<256;n++)t[this.sboxes[e][n]]=n;this.invSboxes.push(t)}}_makePermutation(e){let t=Array(256).fill(!1);for(let n=0;n<256;n++){for(;t[e[n]];)e[n]=e[n]+1&255;t[e[n]]=!0}}_chaoticRng(e){return function(){return e=4294967295&e*1664525+1013904223,(16777215&e)/16777216}}_F(e,t){let n=new Uint8Array(e);for(let r=0;r<8;r++)n[r]^=this.roundKeys[t][r];for(let r=0;r<8;r++){let i=(r+t)%8;n[r]=this.sboxes[i][n[r]]}let r=new Uint8Array(8);for(let i=0;i<8;i++)r[i]=n[(i+t)%8];return r}encryptBlock(e){let t=e.slice(0,8),n=e.slice(8,16);for(let e=0;e<this.rounds;e++){let r=new Uint8Array(8);for(let e=0;e<8;e++)r[e]=t[e]^this._F(n,e)[e];t=n,n=r}let r=new Uint8Array(16);return r.set(t,0),r.set(n,8),r}decryptBlock(e){let t=e.slice(0,8),n=e.slice(8,16);for(let e=this.rounds-1;e>=0;e--){let r=new Uint8Array(8);for(let i=0;i<8;i++)r[i]=n[i]^this._F(t,e)[i];n=t,t=r}let r=new Uint8Array(16);return r.set(t,0),r.set(n,8),r}_pad(e){let t=this.blockSize-e.length%this.blockSize,n=new Uint8Array(e.length+t);n.set(e);for(let r=e.length;r<n.length;r++)n[r]=t;return n}_unpad(e){let t=e[e.length-1];if(t<1||t>this.blockSize)throw new Error("Invalid padding");return e.slice(0,e.length-t)}_entropyFinalizer(e,t){let n=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let i=e[r],a=e[(r+5)%e.length];n[r]=i^(a<<1)^(a>>1)^(255&t)^(23*r)}return n}_reversibleMix(e,t=0){let n=new Uint8Array(e.length);for(let r=0;r<e.length;r++)n[r]=e[r]^((r+t)&255);return n}encrypt(e,t=null){let n=(new TextEncoder).encode(e),r=this._pad(n);let i;if(t&&32===t.length){i=new Uint8Array(16);for(let e=0;e<16;e++)i[e]=parseInt(t.substr(2*e,2),16)}else i=crypto.getRandomValues(new Uint8Array(16));let a=[],o=i;for(let e=0;e<r.length;e+=16){let t=r.slice(e,e+16);for(let e=0;e<16;e++)t[e]^=o[e];let n=this.encryptBlock(t);a.push(n),o=n}let s=new Uint8Array(i.length+r.length);s.set(i);let l=i.length;for(let e=0;e<a.length;e++){let t=this._entropyFinalizer(a[e],e);s.set(t,l),l+=16}return this._bytesToHex(s)}decrypt(e){let t=this._hexToBytes(e);if(t.length<16)throw new Error("Ciphertext too short");let n=t.slice(0,16),r=[];for(let e=16;e<t.length;e+=16)r.push(t.slice(e,e+16));let i=[];for(let e=0;e<r.length;e++){let t=r[e],a=new Uint8Array(16);for(let n=0;n<16;n++){let r=t[n],i=t[(n+5)%16];a[n]=r^(i<<1)^(i>>1)^(255&e)^(23*n)}i.push(a)}let a=[],o=n;for(let e of i){let t=this.decryptBlock(e);for(let e=0;e<16;e++)t[e]^=o[e];a.push(t),o=e}let s=new Uint8Array(16*a.length),l=0;for(let e of a)s.set(e,l),l+=16;let c=this._unpad(s);return(new TextDecoder).decode(c)}_bytesToHex(e){return Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}_hexToBytes(e){let t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substr(n,2),16);return t}testVectors(){const e=[{key:"key1",plain:"Hello World!",iv:"1"},{key:"ðŸŒŸðŸ”¥",plain:"Creative unicode âœ“",iv:"1"},{key:"longkey".repeat(10),plain:"A".repeat(300),iv:"1"}];let t=[];for(let n of e){let r=new AetherCipher(n.key),i=r.encrypt(n.plain,n.iv),a=r.decrypt(i),o=a===n.plain;t.push({key:n.key.substring(0,10)+"â€¦",plain:n.plain.substring(0,20)+"â€¦",pass:o})}return t}avalancheTest(){let e=new AetherCipher("avalanche-key"),t="Hello World! This is a test.",n="Hello World! This is a test?",r=e.encrypt(t,"1"),i=e.encrypt(n,"1"),a=this._hexToBytes(r),o=this._hexToBytes(i),s=0,l=8*a.length;for(let e=0;e<a.length;e++){let t=a[e]^o[e];for(;t;)s+=1&t,t>>=1}return(100*s/l).toFixed(1)}}
